    rules_version = '2';
    service cloud.firestore {
    match /databases/{database}/documents {
        
        // Helper function para verificar se usuário está autenticado
        function isAuthenticated() {
        return request.auth != null;
        }
        
        // Helper function para verificar se é o próprio usuário
        function isOwner(userId) {
        return isAuthenticated() && request.auth.uid == userId;
        }
        
        // ========== USERS ==========
        match /users/{userId} {
        // Qualquer usuário autenticado pode ler perfis
        allow read: if isAuthenticated();
        
        // Apenas o próprio usuário pode criar/editar seu perfil
        allow create, update, delete: if isOwner(userId);
        }
        
        // ========== CHATS ==========
        match /chats/{chatId} {
        // Permitir leitura se o usuário está nos participantes
        allow read: if isAuthenticated() && (
            resource == null ||
            (resource != null && request.auth.uid in resource.data.participants)
        );
        
        // Criar chat se o usuário está nos participantes
        allow create: if isAuthenticated() && 
            request.auth.uid in request.resource.data.participants;
        
        // Atualizar/deletar se o usuário está nos participantes
        allow update, delete: if isAuthenticated() && 
            resource != null &&
            request.auth.uid in resource.data.participants;
        }
        
        // ========== MESSAGES ==========
        match /messages/{messageId} {
        // Leitura: usuário deve ser senderId ou receiverId
        // IMPORTANTE: Para queries funcionarem, não usar resource != null aqui
        allow read: if isAuthenticated() && (
            resource == null ||
            (resource != null && (
            request.auth.uid == resource.data.senderId ||
            request.auth.uid == resource.data.receiverId
            ))
        );
        
        // Criação: apenas o remetente pode criar
        // REGRA SIMPLIFICADA: apenas verificar se senderId corresponde ao usuário autenticado
        allow create: if isAuthenticated() && 
            request.resource.data.senderId == request.auth.uid &&
            request.resource.data.receiverId != null &&
            request.resource.data.chatId != null &&
            request.resource.data.content != null;
        
        // Atualização: 
        // - Remetente pode atualizar qualquer campo se a mensagem não foi enviada
        // - Remetente pode atualizar apenas campos específicos se já foi enviada
        // - Destinatário pode atualizar readBy, readAt e reactions
        allow update: if isAuthenticated() && (
            // Remetente pode atualizar
            (request.auth.uid == resource.data.senderId && (
            // Se não foi enviada, pode editar tudo
            !resource.data.sent ||
            // Se foi enviada, só pode atualizar campos específicos
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy', 'readAt', 'reactions', 'pinned'])
            )) ||
            // Destinatário pode atualizar apenas readBy, readAt e reactions
            (request.auth.uid == resource.data.receiverId &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy', 'readAt', 'reactions']))
        );
        
        // Deletar: apenas o remetente
        allow delete: if isAuthenticated() && 
            resource != null &&
            request.auth.uid == resource.data.senderId;
        }
        
    // ========== PENDING MESSAGES ==========
    match /pendingMessages/{messageId} {
      // Apenas o remetente pode ler suas mensagens pendentes
      allow read: if isAuthenticated() && (
        resource == null ||
        (resource != null && request.auth.uid == resource.data.senderId)
      );
      
      // Apenas o remetente pode criar mensagens pendentes
      allow create: if isAuthenticated() && 
        request.resource.data.senderId == request.auth.uid &&
        request.resource.data.receiverId != null &&
        request.resource.data.chatId != null &&
        request.resource.data.content != null;
      
      // Apenas o remetente pode atualizar suas mensagens pendentes
      allow update: if isAuthenticated() && 
        resource != null &&
        request.auth.uid == resource.data.senderId &&
        // Garantir que o senderId não seja alterado
        request.resource.data.senderId == resource.data.senderId;
      
      // Apenas o remetente pode deletar suas mensagens pendentes
      allow delete: if isAuthenticated() && 
        resource != null &&
        request.auth.uid == resource.data.senderId;
    }
        
        // ========== BLOCKED ATTEMPTS ==========
        match /blockedAttempts/{attemptId} {
        // Apenas o receptor pode ler suas tentativas bloqueadas
        allow read: if isAuthenticated() && (
            resource == null ||
            (resource != null && request.auth.uid == resource.data.receiverId)
        );
        
        // Qualquer usuário autenticado pode criar tentativas
        allow create: if isAuthenticated();
        
        // Apenas o receptor pode atualizar/deletar tentativas
        allow update, delete: if isAuthenticated() && 
            resource != null &&
            request.auth.uid == resource.data.receiverId;
        }
        
        // ========== BLOCKED USERS ==========
        match /blockedUsers/{blockId} {
        // Apenas o usuário que bloqueou pode ler seus bloqueios
        allow read: if isAuthenticated() && (
            resource == null ||
            (resource != null && request.auth.uid == resource.data.userId)
        );
        
        // Apenas o próprio usuário pode criar bloqueios
        allow create: if isAuthenticated() && 
            request.resource.data.userId == request.auth.uid;
        
        // Apenas o próprio usuário pode deletar seus bloqueios
        allow delete: if isAuthenticated() && 
            resource != null &&
            request.auth.uid == resource.data.userId;
        }
        
        // ========== TYPING STATUS ==========
        match /typingStatus/{chatId} {
        // Leitura: verificar se é participante (com tratamento de erro se chat não existir)
        allow read: if isAuthenticated() && (
            !exists(/databases/$(database)/documents/chats/$(chatId)) ||
            (exists(/databases/$(database)/documents/chats/$(chatId)) &&
            request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants)
        );
        
        // Escrita: verificar se é participante (com tratamento de erro se chat não existir)
        allow write: if isAuthenticated() && (
            !exists(/databases/$(database)/documents/chats/$(chatId)) ||
            (exists(/databases/$(database)/documents/chats/$(chatId)) &&
            request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants)
        );
        }
    }
    }
